"use client";

import { useEffect, useMemo, useState } from "react";
import { dailyKey } from "@/lib/period";
import { supabase } from "@/lib/supabase";
import { getHouseMembers, getMeAndHousehold } from "@/lib/session";
import { ensureDailyOccurrences } from "@/lib/ensureOccurrences";

type Row = {
  id: string;
  status: string;
  marked_by: string | null;
  task: { id: string; title: string; sort_order: number; task_assignees: { assignee_id: string }[] };
};

export default function TodayPage() {
  const key = useMemo(() => dailyKey(new Date()), []);
  const [me, setMe] = useState<{ id: string; name: string; household_id: string } | null>(null);
  const [members, setMembers] = useState<{ id: string; name: string }[]>([]);
  const [rows, setRows] = useState<Row[]>([]);
  const [err, setErr] = useState<string | null>(null);

  async function load() {
    setErr(null);
    const mine = await getMeAndHousehold();
    setMe(mine);
    const mems = await getHouseMembers(mine.household_id);
    setMembers(mems);

    const data = await ensureDailyOccurrences(mine.household_id, key);
    setRows(data as any);
  }

  async function setStatus(occurrenceId: string, status: string) {
    const { data: auth } = await supabase.auth.getUser();
    const userId = auth.user?.id ?? null;

    const { error } = await supabase
      .from("task_occurrences")
      .update({ status, marked_by: userId, marked_at: new Date().toISOString() })
      .eq("id", occurrenceId);

    if (error) setErr(error.message);
    await load();
  }

  useEffect(() => { load().catch((e) => setErr(e.message)); }, []);

  if (!me) return <main style={{ padding: 16 }}><p>Carregando…</p></main>;

  const myId = me.id;
  const other = members.find((m) => m.id !== myId);

  function bucket(assignees: string[]) {
    const hasMe = assignees.includes(myId);
    const hasOther = other ? assignees.includes(other.id) : false;
    if (hasMe && hasOther) return "AMBOS";
    if (hasMe) return "MINHAS";
    if (hasOther) return "DELE";
    return "SEM";
  }

  const groups: Record<string, Row[]> = { MINHAS: [], DELE: [], AMBOS: [], SEM: [] };
  rows
    .slice()
    .sort((a, b) => (a.task.sort_order ?? 0) - (b.task.sort_order ?? 0))
    .forEach((r) => {
      const ass = (r.task.task_assignees ?? []).map((x) => x.assignee_id);
      groups[bucket(ass)].push(r);
    });

  return (
    <main style={{ padding: 16, maxWidth: 900, margin: "0 auto" }}>
      <h1>Hoje ({key})</h1>
      {err && <p style={{ color: "crimson" }}>{err}</p>}

      <Section label={`Minhas (${me.name})`} rows={groups.MINHAS} onSetStatus={setStatus} />
      <Section label={`Dele (${other?.name ?? "Outro"})`} rows={groups.DELE} onSetStatus={setStatus} />
      <Section label="Ambos" rows={groups.AMBOS} onSetStatus={setStatus} />
      {groups.SEM.length > 0 && <Section label="Sem responsável" rows={groups.SEM} onSetStatus={setStatus} />}
    </main>
  );
}

function Section({ label, rows, onSetStatus }: { label: string; rows: Row[]; onSetStatus: (id: string, status: string) => void }) {
  if (!rows.length) return null;
  return (
    <div style={{ marginTop: 18 }}>
      <h2>{label}</h2>
      <ul style={{ listStyle: "none", padding: 0, display: "grid", gap: 12 }}>
        {rows.map((r) => (
          <li key={r.id} style={{ border: "1px solid #ddd", borderRadius: 12, padding: 12 }}>
            <div style={{ display: "flex", justifyContent: "space-between", gap: 12 }}>
              <strong>{r.task.title}</strong>
              <span>{r.status}</span>
            </div>
            <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginTop: 10 }}>
              <button onClick={() => onSetStatus(r.id, "FEITA")}>Feita</button>
              <button onClick={() => onSetStatus(r.id, "FEITA_COM_PROBLEMA")}>Feita c/ problema</button>
              <button onClick={() => onSetStatus(r.id, "NAO_FEITA")}>Não feita</button>
              <button onClick={() => onSetStatus(r.id, "NAO_SE_APLICA")}>Não se aplica</button>
              <button onClick={() => onSetStatus(r.id, "PENDENTE")}>Reset</button>
            </div>
          </li>
        ))}
      </ul>
    </div>
  );
}
